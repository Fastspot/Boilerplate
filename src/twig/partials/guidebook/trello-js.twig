<script>
	var trelloFormatter;
	var trelloHash;
	var trelloDetails;

	trelloInit();

	function trelloInit() {
		bindTrelloVars();
		bindTrelloUI();
		queryTrelloHash();
		checkEmptySections();
	}

	function bindTrelloVars() {
		trelloFormatter = document.querySelector('.gb_trello_formatter');
		trelloDetails = document.querySelectorAll('.gb_trello_detail');
	}

	function bindTrelloUI() {
		window.addEventListener('hashchange', queryTrelloHash, false);

		trelloFormatter.addEventListener('click', toggleTrelloFormat, false);
	}

	function queryTrelloHash() {
		closeTrelloDetails();

		if(window.location.hash) {
			trelloHash = window.location.hash;
			if(trelloHash.indexOf('trelloList') !== 1) {
				openTrelloDetail();
				openTrelloDetailHash(trelloHash);
				loadTrelloDetailImage(trelloHash);
			}
		} else if(trelloHash !== undefined) {
			closeTrelloDetail();
			closeTrelloDetailHash(trelloHash);
		}
	}

	function openTrelloDetail() {
		document.body.classList.add('fs-trello-lock');
	}

	function openTrelloDetailHash(hash) {
		document.querySelector(hash).classList.add('fs-swap-active');
	}

	function loadTrelloDetailImage(hash) {
		var cover = document.querySelector(hash + ' .gb_trello_detail_cover');

		if(cover && !(cover.classList.contains('image-loaded'))) {
			var image = document.createElement('img');
			image.classList.add('gb_trello_detail_image');
			image.setAttribute('src', cover.dataset.image);

			cover.appendChild(image);
			cover.classList.add('image-loaded');
		}
	}

	function closeTrelloDetail() {
		document.body.classList.remove('fs-trello-lock');
	}

	function closeTrelloDetails() {
		for(var i = 0; i < trelloDetails.length; i++) {
			trelloDetails[i].classList.remove('fs-swap-active');
		}
	}

	function closeTrelloDetailHash(hash) {
		document.querySelector(hash).classList.remove('fs-swap-active');
	}

	function toggleTrelloFormat(e) {
		var list = e.currentTarget.parentElement.parentElement.parentElement.parentElement;

		if(list.classList.contains('trello_format_list')) {
			list.classList.remove('trello_format_list');
		} else {
			list.classList.add('trello_format_list');
		}
	}

	function checkEmptySections() {
		var topicGroups = document.querySelectorAll('.gb_topics');

		for(var i = 0; i < topicGroups.length; i++) {
			if(topicGroups[i].firstElementChild === null) {
				topicGroups[i].parentElement.parentElement.classList.add('empty');
				topicGroups[i].parentElement.parentElement.innerHTML = '';
			}
		}
	}
</script>
